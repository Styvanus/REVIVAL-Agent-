<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Report Card Generator</title>
    <style>
        body {
            font-family: 'Helvetica', sans-serif;
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background-color: #f4f6f9;
        }
        .form-container, .report-container, .preview-container {
            border: 1px solid #2c3e50;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .background-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #d1d5db;
            padding: 6px;
            text-align: center;
        }
        th {
            background-color: #2c3e50;
            color: #ffffff;
            font-weight: 600;
            font-size: 10px;
        }
        .grade-A { color: #28a745; font-weight: bold; }
        .grade-B { color: #007bff; font-weight: bold; }
        .grade-C { color: #fd7e14; font-weight: bold; }
        .grade-D { color: #6f42c1; font-weight: bold; }
        .grade-F { color: #dc3545; font-weight: bold; }
        .logo-container {
            width: 100px;
            height: 100px;
            border: 1px solid #d1d5db;
            margin: 10px auto;
            background-color: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 4px;
        }
        .photo-container {
            width: 100px;
            height: 100px;
            margin: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 8px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
        img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }
        .header-container {
            text-align: center;
            margin-bottom: 15px;
        }
        .school-name {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin: 8px 0 4px 0;
        }
        .school-info p {
            margin: 4px 0;
            text-align: center;
            font-size: 11px;
            color: #2c3e50;
        }
        .report-title {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
            text-decoration: underline;
            margin: 4px 0;
            color: #2c3e50;
        }
        .student-details {
            background: linear-gradient(to right, #e0e7ff, #f0f4ff);
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .student-details p {
            font-size: 14px;
            font-weight: 600;
            margin: 4px 0;
        }
        .student-details p.student-name span, .student-details p.admission-number span {
            font-weight: 700;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
            background-color: #2c3e50;
            color: #ffffff;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #34495e;
        }
        .remarks, .school-info, .grade-summary {
            margin-top: 15px;
        }
        .remarks p, .student-title p {
            font-size: 12px;
            margin: 4px 0;
        }
        .student-title {
            text-align: center;
            font-style: italic;
        }
        textarea {
            width: 100%;
            height: 80px;
            margin-top: 5px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 8px;
            font-size: 14px;
        }
        input, select {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        label {
            font-weight: 500;
            margin-right: 10px;
        }
        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .preview-container {
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <div class="form-container">
        <h2>School Report Card Generator</h2>
        <form id="reportForm">
            <label>School Name: <input type="text" id="schoolName" placeholder="Enter School Name" required></label><br><br>
            <label>School Address: <input type="text" id="schoolAddress" placeholder="Enter School Address" required></label><br><br>
            <label>Contact Number: <input type="text" id="contactNumber" placeholder="Enter Contact Number" required></label><br><br>
            <label>School Logo: <input type="file" id="logoInput" accept="image/*"></label><br><br>
            <label>Watermark Background: <input type="file" id="watermarkInput" accept="image/*"></label><br><br>
            <label>Background Color: <input type="color" id="backgroundColor" value="#ffffff"></label><br><br>
            <label>Background Opacity: <input type="range" id="backgroundOpacity" min="0.1" max="1.0" step="0.1" value="1.0"></label><br><br>
            <label>Font: 
                <select id="fontSelect">
                    <option value="Helvetica">Helvetica</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Georgia">Georgia</option>
                </select>
            </label><br><br>
            <label>Text Color: <input type="color" id="textColor" value="#2c3e50"></label><br><br>
            <label>Student Photo Background Color: <input type="color" id="photoBackgroundColor" value="#f9fafb"></label><br><br>
            <label>Student Name: <input type="text" id="studentName" required></label><br><br>
            <label>Admission Number: <input type="text" id="admissionNumber" required></label><br><br>
            <label>Sex: 
                <select id="studentSex" required>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
            </label><br><br>
            <label>Class: 
                <select id="classSelect" required>
                    <option value="Basic 1">Basic 1</option>
                    <option value="Basic 2">Basic 2</option>
                    <option value="Basic 3">Basic 3</option>
                    <option value="Basic 4">Basic 4</option>
                    <option value="Basic 5">Basic 5</option>
                    <option value="Basic 6">Basic 6</option>
                    <option value="JSS 1">JSS 1</option>
                    <option value="JSS 2">JSS 2</option>
                    <option value="JSS 3">JSS 3</option>
                    <option value="SS 1">SS 1</option>
                    <option value="SS 2">SS 2</option>
                    <option value="SS 3">SS 3</option>
                </select>
            </label><br><br>
            <label>Term: 
                <select id="termSelect" required>
                    <option value="First">First Term</option>
                    <option value="Second">Second Term</option>
                    <option value="Third">Third Term</option>
                </select>
            </label><br><br>
            <label>Student Photo: <input type="file" id="photoInput" accept="image/*"></label>
            <label>Photo Position: 
                <select id="photoPosition">
                    <option value="left">Left</option>
                    <option value="right">Right</option>
                </select>
            </label><br><br>
            <label>Position: <input type="text" id="positionInput" required></label><br><br>
            <label>School Opens: <input type="date" id="schoolOpens" required></label><br><br>
            <label>School Closes: <input type="date" id="schoolCloses" required></label><br><br>
            <label>Reopen Date: <input type="date" id="reopenDate" required></label><br><br>
            <label>No. of Times Student Present: <input type="number" id="studentPresentCount" min="0" required></label><br><br>
            <label>Teacher's Remark: <textarea id="teacherRemark"></textarea></label><br><br>
            <h3>Subject Scores</h3>
            <div id="subjectInputs"></div>
            <button type="button" onclick="addSubject()">Add Subject</button>
            <button type="button" onclick="previewReport()">Preview Report</button>
            <button type="button" onclick="exportPDF()">Export to PDF</button>
        </form>
    </div>
    <div class="preview-container" id="previewOutput" style="display: none;">
        <div class="background-layer" id="previewBackgroundLayer"></div>
        <div class="header-container">
            <div id="previewLogoContainer" class="logo-container"></div>
            <h2 id="previewSchoolName" class="school-name"></h2>
            <div class="school-info">
                <p id="previewSchoolAddress"></p>
                <p id="previewContactNumber"></p>
                <p class="report-title">STUDENT REPORT CARD</p>
            </div>
        </div>
        <div class="student-details">
            <div id="previewPhotoContainer" class="photo-container"></div>
            <div>
                <p class="student-name"><strong>Student:</strong> <span id="previewStudentName"></span></p>
                <p class="admission-number"><strong>Admission Number:</strong> <span id="previewAdmissionNumber"></span></p>
                <p><strong>Sex:</strong> <span id="previewStudentSex"></span></p>
                <p><strong>Class:</strong> <span id="previewClass"></span></p>
                <p><strong>Term:</strong> <span id="previewTerm"></span></p>
                <p><strong>Position:</strong> <span id="previewPosition"></span></p>
            </div>
        </div>
        <div class="school-info">
            <p><strong>School Opens:</strong> <span id="previewSchoolOpens"></span></p>
            <p><strong>School Closes:</strong> <span id="previewSchoolCloses"></span></p>
            <p><strong>Reopen Date:</strong> <span id="previewReopenDate"></span></p>
            <p><strong>No. of Times School Opens:</strong> <span id="previewSchoolOpenCount"></span></p>
            <p><strong>No. of Times Student Present:</strong> <span id="previewStudentPresentCount"></span></p>
            <p><strong>Average Attendance:</strong> <span id="previewAverageAttendance"></span>%</p>
        </div>
        <table id="previewTable">
            <thead id="previewTableHead"></thead>
            <tbody id="previewTableBody"></tbody>
        </table>
        <div class="grade-summary">
            <p><strong>Cumulative Total:</strong> <span id="previewCumulativeTotal"></span></p>
            <p><strong>Cumulative Average:</strong> <span id="previewCumulativeAverage"></span></p>
            <p><strong>Overall Grade:</strong> <span id="previewOverallGrade"></span></p>
        </div>
        <div class="remarks">
            <p><strong>Teacher's Remark:</strong> <span id="previewTeacherRemark"></span></p>
            <p><strong>Head Teacher's Remark:</strong> <span id="previewHeadTeacherRemark">——————</span></p>
        </div>
        <div class="student-title">
            <p><strong>Student Title:</strong> <span id="previewStudentTitle"></span></p>
        </div>
        <button type="button" onclick="saveReport()">Save Report</button>
        <button type="button" onclick="document.getElementById('previewOutput').style.display = 'none'">Edit Report</button>
    </div>
    <div class="report-container" id="reportOutput" style="display: none;">
        <div class="background-layer" id="reportBackgroundLayer"></div>
        <div class="header-container">
            <div id="reportLogoContainer" class="logo-container"></div>
            <h2 id="reportSchoolName" class="school-name"></h2>
            <div class="school-info">
                <p id="reportSchoolAddress"></p>
                <p id="reportContactNumber"></p>
                <p class="report-title">STUDENT REPORT CARD</p>
            </div>
        </div>
        <div class="student-details">
            <div id="reportPhotoContainer" class="photo-container"></div>
            <div>
                <p class="student-name"><strong>Student:</strong> <span id="reportStudentName"></span></p>
                <p class="admission-number"><strong>Admission Number:</strong> <span id="reportAdmissionNumber"></span></p>
                <p><strong>Sex:</strong> <span id="reportStudentSex"></span></p>
                <p><strong>Class:</strong> <span id="reportClass"></span></p>
                <p><strong>Term:</strong> <span id="reportTerm"></span></p>
                <p><strong>Position:</strong> <span id="reportPosition"></span></p>
            </div>
        </div>
        <div class="school-info">
            <p><strong>School Opens:</strong> <span id="reportSchoolOpens"></span></p>
            <p><strong>School Closes:</strong> <span id="reportSchoolCloses"></span></p>
            <p><strong>Reopen Date:</strong> <span id="reportReopenDate"></span></p>
            <p><strong>No. of Times School Opens:</strong> <span id="reportSchoolOpenCount"></span></p>
            <p><strong>No. of Times Student Present:</strong> <span id="reportStudentPresentCount"></span></p>
            <p><strong>Average Attendance:</strong> <span id="reportAverageAttendance"></span>%</p>
        </div>
        <table id="reportTable">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="grade-summary">
            <p><strong>Cumulative Total:</strong> <span id="reportCumulativeTotal"></span></p>
            <p><strong>Cumulative Average:</strong> <span id="reportCumulativeAverage"></span></p>
            <p><strong>Overall Grade:</strong> <span id="reportOverallGrade"></span></p>
        </div>
        <div class="remarks">
            <p><strong>Teacher's Remark:</strong> <span id="reportTeacherRemark"></span></p>
            <p><strong>Head Teacher's Remark:</strong> <span id="reportHeadTeacherRemark">——————</span></p>
        </div>
        <div class="student-title">
            <p><strong>Student Title:</strong> <span id="reportStudentTitle"></span></p>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        let subjects = [];
        let savedReports = JSON.parse(localStorage.getItem('reports')) || [];

        function addSubject() {
            const container = document.getElementById('subjectInputs');
            const div = document.createElement('div');
            const classType = document.getElementById('classSelect').value;
            const term = document.getElementById('termSelect').value;
            let scoreFields = '';
            if (term === 'First' || term === 'Second') {
                const caFields = classType.startsWith('Basic') ? `
                    <input type="number" class="ca1" min="0" max="10" placeholder="CA1 (10)" required>
                    <input type="number" class="ca2" min="0" max="10" placeholder="CA2 (10)" required>
                    <input type="number" class="ca3" min="0" max="10" placeholder="CA3 (10)" required>
                    <input type="number" class="ca4" min="0" max="10" placeholder="CA4 (10)" required>
                    <input type="number" class="exam" min="0" max="60" placeholder="Exam (60)" required>
                ` : `
                    <input type="number" class="ca1" min="0" max="10" placeholder="CA1 (10)" required>
                    <input type="number" class="ca2" min="0" max="10" placeholder="CA2 (10)" required>
                    <input type="number" class="ca3" min="0" max="10" placeholder="CA3 (10)" required>
                    <input type="number" class="exam" min="0" max="70" placeholder="Exam (70)" required>
                `;
                scoreFields = `<label>${term} Term: ${caFields}</label>`;
            } else {
                const caFields = classType.startsWith('Basic') ? `
                    <input type="number" class="ca1" min="0" max="10" placeholder="CA1 (10)" required>
                    <input type="number" class="ca2" min="0" max="10" placeholder="CA2 (10)" required>
                    <input type="number" class="ca3" min="0" max="10" placeholder="CA3 (10)" required>
                    <input type="number" class="ca4" min="0" max="10" placeholder="CA4 (10)" required>
                    <input type="number" class="exam" min="0" max="60" placeholder="Exam (60)" required>
                ` : `
                    <input type="number" class="ca1" min="0" max="10" placeholder="CA1 (10)" required>
                    <input type="number" class="ca2" min="0" max="10" placeholder="CA2 (10)" required>
                    <input type="number" class="ca3" min="0" max="10" placeholder="CA3 (10)" required>
                    <input type="number" class="exam" min="0" max="70" placeholder="Exam (70)" required>
                `;
                scoreFields = `
                    <label>First Term Total: <input type="number" class="firstTermTotal" min="0" max="100" required></label>
                    <label>Second Term Total: <input type="number" class="secondTermTotal" min="0" max="100" required></label>
                    <label>Third Term: ${caFields}</label>
                `;
            }
            div.innerHTML = `
                <label>Subject: <input type="text" class="subjectName" required></label>
                <label>Position: <input type="text" class="subjectPosition" required></label>
                ${scoreFields}
                <button type="button" onclick="this.parentElement.remove()">Remove</button><br><br>
            `;
            container.appendChild(div);
        }

        function calculateGrade(score) {
            if (score >= 70) return 'A';
            if (score >= 60) return 'B';
            if (score >= 50) return 'C';
            if (score >= 40) return 'D';
            return 'F';
        }

        function calculateSchoolOpenDays(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            let count = 0;
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                if (d.getDay() !== 0 && d.getDay() !== 6) count++; // Exclude weekends
            }
            return count;
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return [r, g, b];
        }

        function generateStudentTitle(subjects, term) {
            const scienceSubjects = ['mathematics', 'physics', 'chemistry', 'biology', 'integrated science'];
            const artsSubjects = ['english', 'literature', 'history', 'social studies', 'geography'];
            const vocationalSubjects = ['technical drawing', 'home economics', 'agricultural science'];

            const topScore = Math.max(...subjects.map(s => term === 'Third' ? s.overallTotal : s.termTotal));
            const topSubjects = subjects.filter(s => (term === 'Third' ? s.overallTotal : s.termTotal) === topScore);

            if (topScore < 70) return 'Emerging Talent';

            const isScience = topSubjects.every(s => scienceSubjects.includes(s.subjectName.toLowerCase()));
            const isArts = topSubjects.every(s => artsSubjects.includes(s.subjectName.toLowerCase()));
            const isVocational = topSubjects.every(s => vocationalSubjects.includes(s.subjectName.toLowerCase()));

            if (isScience) {
                return topSubjects.length > 1 ? 'Master of Sciences' : 'Science Prodigy';
            } else if (isArts) {
                return topSubjects.length > 1 ? 'Humanities Hero' : 'Literary Luminary';
            } else if (isVocational) {
                return topSubjects.length > 1 ? 'Creative Craftsman' : 'Technical Titan';
            } else if (topSubjects.length > 2) {
                return 'Academic Star';
            } else {
                return 'Scholar Supreme';
            }
        }

        function generateReportData() {
            const schoolName = document.getElementById('schoolName').value;
            const schoolAddress = document.getElementById('schoolAddress').value;
            const contactNumber = document.getElementById('contactNumber').value;
            const font = document.getElementById('fontSelect').value;
            const textColor = document.getElementById('textColor').value;
            const photoBackgroundColor = document.getElementById('photoBackgroundColor').value;
            const backgroundOpacity = parseFloat(document.getElementById('backgroundOpacity').value);
            const studentName = document.getElementById('studentName').value;
            const admissionNumber = document.getElementById('admissionNumber').value;
            const studentSex = document.getElementById('studentSex').value;
            const classType = document.getElementById('classSelect').value;
            const term = document.getElementById('termSelect').value;
            const position = document.getElementById('positionInput').value;
            const schoolOpens = document.getElementById('schoolOpens').value;
            const schoolCloses = document.getElementById('schoolCloses').value;
            const reopenDate = document.getElementById('reopenDate').value;
            const studentPresentCount = parseInt(document.getElementById('studentPresentCount').value) || 0;
            const teacherRemark = document.getElementById('teacherRemark').value;
            const photo = document.getElementById('photoInput').files[0];
            const logo = document.getElementById('logoInput').files[0];
            const watermark = document.getElementById('watermarkInput').files[0];
            const backgroundColor = document.getElementById('backgroundColor').value;
            const photoPosition = document.getElementById('photoPosition').value;

            if (!schoolName || !schoolAddress || !contactNumber || !studentName || !admissionNumber || !studentSex || !classType || !term || !position || !schoolOpens || !schoolCloses || !reopenDate || !studentPresentCount) {
                alert('Please fill all required fields.');
                return null;
            }

            const subjectInputs = document.querySelectorAll('#subjectInputs > div');
            if (subjectInputs.length === 0) {
                alert('Please add at least one subject.');
                return null;
            }

            for (const input of subjectInputs) {
                const subjectName = input.querySelector('.subjectName').value;
                const subjectPosition = input.querySelector('.subjectPosition').value;
                if (!subjectName || !subjectPosition) {
                    alert('Please fill all subject fields.');
                    return null;
                }
                if (term === 'Third') {
                    const firstTermTotal = input.querySelector('.firstTermTotal')?.value;
                    const secondTermTotal = input.querySelector('.secondTermTotal')?.value;
                    if (!firstTermTotal || !secondTermTotal) {
                        alert('Please fill First and Second Term Totals for Third Term.');
                        return null;
                    }
                }
            }

            const schoolOpenCount = calculateSchoolOpenDays(schoolOpens, schoolCloses);
            const averageAttendance = schoolOpenCount > 0 ? (studentPresentCount / schoolOpenCount * 100).toFixed(2) : 0;

            subjects = [];
            let cumulativeTotal = 0;
            let subjectCount = 0;
            subjectInputs.forEach(input => {
                const subjectName = input.querySelector('.subjectName').value;
                const subjectPosition = input.querySelector('.subjectPosition').value;
                let ca1 = 0, ca2 = 0, ca3 = 0, ca4 = 0, exam = 0, termTotal = 0, firstTermTotal = 0, secondTermTotal = 0, overallTotal = 0, average = 0;
                if (term === 'First' || term === 'Second') {
                    ca1 = parseInt(input.querySelector('.ca1')?.value) || 0;
                    ca2 = parseInt(input.querySelector('.ca2')?.value) || 0;
                    ca3 = parseInt(input.querySelector('.ca3')?.value) || 0;
                    ca4 = classType.startsWith('Basic') ? parseInt(input.querySelector('.ca4')?.value) || 0 : 0;
                    exam = parseInt(input.querySelector('.exam')?.value) || 0;
                    termTotal = classType.startsWith('Basic') ? ca1 + ca2 + ca3 + ca4 + exam : ca1 + ca2 + ca3 + exam;
                    if (term === 'First') firstTermTotal = termTotal;
                    else secondTermTotal = termTotal;
                } else {
                    ca1 = parseInt(input.querySelector('.ca1')?.value) || 0;
                    ca2 = parseInt(input.querySelector('.ca2')?.value) || 0;
                    ca3 = parseInt(input.querySelector('.ca3')?.value) || 0;
                    ca4 = classType.startsWith('Basic') ? parseInt(input.querySelector('.ca4')?.value) || 0 : 0;
                    exam = parseInt(input.querySelector('.exam')?.value) || 0;
                    firstTermTotal = parseInt(input.querySelector('.firstTermTotal')?.value) || 0;
                    secondTermTotal = parseInt(input.querySelector('.secondTermTotal')?.value) || 0;
                    termTotal = classType.startsWith('Basic') ? ca1 + ca2 + ca3 + ca4 + exam : ca1 + ca2 + ca3 + exam;
                    overallTotal = firstTermTotal + secondTermTotal + termTotal;
                    average = overallTotal / 3;
                }
                const grade = term === 'Third' ? calculateGrade(overallTotal) : calculateGrade(termTotal);
                subjects.push({ 
                    subjectName, subjectPosition, 
                    ca1, ca2, ca3, ca4, exam, 
                    firstTermTotal, secondTermTotal, thirdTermTotal: term === 'Third' ? termTotal : 0, 
                    termTotal, overallTotal, average, grade 
                });
                cumulativeTotal += term === 'Third' ? overallTotal : termTotal;
                subjectCount++;
            });

            const cumulativeAverage = subjectCount > 0 ? cumulativeTotal / subjectCount : 0;
            const overallGrade = calculateGrade(cumulativeAverage);
            const studentTitle = generateStudentTitle(subjects, term);

            return {
                schoolName, schoolAddress, contactNumber, font, textColor, photoBackgroundColor, backgroundOpacity,
                studentName, admissionNumber, studentSex, classType, term, position,
                schoolOpens, schoolCloses, reopenDate, schoolOpenCount, studentPresentCount, averageAttendance,
                teacherRemark, photo, logo, watermark, backgroundColor, photoPosition,
                subjects, cumulativeTotal, cumulativeAverage, overallGrade, studentTitle
            };
        }

        function renderReport(containerPrefix, data) {
            const { schoolName, schoolAddress, contactNumber, font, textColor, photoBackgroundColor, backgroundOpacity,
                    studentName, admissionNumber, studentSex, classType, term, position,
                    schoolOpens, schoolCloses, reopenDate, schoolOpenCount, studentPresentCount, averageAttendance,
                    teacherRemark, photo, logo, photoPosition, subjects, cumulativeTotal, cumulativeAverage, overallGrade, studentTitle } = data;

            // Update font and text color
            const output = document.getElementById(`${containerPrefix}Output`);
            output.style.fontFamily = font;
            output.style.color = textColor;

            // Update background layer
            const backgroundLayer = document.getElementById(`${containerPrefix}BackgroundLayer`);
            backgroundLayer.style.backgroundColor = backgroundColor;
            backgroundLayer.style.opacity = backgroundOpacity;

            // Update report output
            output.style.display = 'block';
            document.getElementById(`${containerPrefix}SchoolName`).textContent = schoolName || 'School Name';
            document.getElementById(`${containerPrefix}SchoolAddress`).textContent = schoolAddress || 'N/A';
            document.getElementById(`${containerPrefix}ContactNumber`).textContent = contactNumber || 'N/A';
            document.getElementById(`${containerPrefix}StudentName`).textContent = studentName;
            document.getElementById(`${containerPrefix}AdmissionNumber`).textContent = admissionNumber || 'N/A';
            document.getElementById(`${containerPrefix}StudentSex`).textContent = studentSex;
            document.getElementById(`${containerPrefix}Class`).textContent = classType;
            document.getElementById(`${containerPrefix}Term`).textContent = term;
            document.getElementById(`${containerPrefix}Position`).textContent = position;
            document.getElementById(`${containerPrefix}SchoolOpens`).textContent = schoolOpens || 'N/A';
            document.getElementById(`${containerPrefix}SchoolCloses`).textContent = schoolCloses || 'N/A';
            document.getElementById(`${containerPrefix}ReopenDate`).textContent = reopenDate || 'N/A';
            document.getElementById(`${containerPrefix}SchoolOpenCount`).textContent = schoolOpenCount || 'N/A';
            document.getElementById(`${containerPrefix}StudentPresentCount`).textContent = studentPresentCount || 'N/A';
            document.getElementById(`${containerPrefix}AverageAttendance`).textContent = averageAttendance || 'N/A';
            document.getElementById(`${containerPrefix}TeacherRemark`).textContent = teacherRemark || 'N/A';
            document.getElementById(`${containerPrefix}HeadTeacherRemark`).textContent = '——————';
            document.getElementById(`${containerPrefix}CumulativeTotal`).textContent = cumulativeTotal.toFixed(2);
            document.getElementById(`${containerPrefix}CumulativeAverage`).textContent = cumulativeAverage.toFixed(2);
            document.getElementById(`${containerPrefix}OverallGrade`).textContent = overallGrade;
            document.getElementById(`${containerPrefix}OverallGrade`).className = `grade-${overallGrade}`;
            document.getElementById(`${containerPrefix}StudentTitle`).textContent = studentTitle;

            // Logo handling
            const logoContainer = document.getElementById(`${containerPrefix}LogoContainer`);
            logoContainer.innerHTML = 'School Logo';
            if (logo) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(logo);
                logoContainer.innerHTML = '';
                logoContainer.appendChild(img);
            }

            // Photo handling
            const photoContainer = document.getElementById(`${containerPrefix}PhotoContainer`);
            photoContainer.innerHTML = '';
            photoContainer.style.float = photoPosition;
            photoContainer.style.backgroundColor = photoBackgroundColor;
            if (photo) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(photo);
                photoContainer.appendChild(img);
            }

            // Table header
            const tableHead = document.getElementById(`${containerPrefix}TableHead`);
            tableHead.innerHTML = `
                <tr>
                    <th>Subject</th>
                    <th>Position</th>
                    <th>CA1</th><th>CA2</th><th>CA3</th>
                    ${classType.startsWith('Basic') ? '<th>CA4</th>' : ''}
                    <th>Exam</th>
                    <th>${term} Term</th>
                    ${term === 'Third' ? '<th>First Term</th><th>Second Term</th><th>Total</th><th>Average</th>' : ''}
                    <th>Grade</th>
                </tr>
            `;

            // Table body
            const tableBody = document.getElementById(`${containerPrefix}TableBody`);
            tableBody.innerHTML = '';
            subjects.forEach(subject => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${subject.subjectName}</td>
                    <td>${subject.subjectPosition}</td>
                    <td>${subject.ca1}</td>
                    <td>${subject.ca2}</td>
                    <td>${subject.ca3}</td>
                    ${classType.startsWith('Basic') ? `<td>${subject.ca4}</td>` : ''}
                    <td>${subject.exam}</td>
                    <td>${subject.termTotal}</td>
                    ${term === 'Third' ? `
                        <td>${subject.firstTermTotal}</td>
                        <td>${subject.secondTermTotal}</td>
                        <td>${subject.overallTotal}</td>
                        <td>${subject.average.toFixed(2)}</td>
                    ` : ''}
                    <td class="grade-${subject.grade}">${subject.grade}</td>
                `;
                tableBody.appendChild(row);
            });

            // Cumulative row for third term
            if (term === 'Third') {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>Cumulative</strong></td>
                    <td></td>
                    <td></td><td></td><td></td>
                    ${classType.startsWith('Basic') ? '<td></td>' : ''}
                    <td></td><td></td>
                    <td></td><td></td>
                    <td><strong>${cumulativeTotal}</strong></td>
                    <td><strong>${cumulativeAverage.toFixed(2)}</strong></td>
                    <td></td>
                `;
                tableBody.appendChild(row);
            }
        }

        function previewReport() {
            const data = generateReportData();
            if (!data) return;
            renderReport('preview', data);
            document.getElementById('reportOutput').style.display = 'none';
        }

        function saveReport() {
            const data = generateReportData();
            if (!data) return;
            savedReports.push(data);
            localStorage.setItem('reports', JSON.stringify(savedReports));
            alert('Report saved!');
            document.getElementById('previewOutput').style.display = 'none';
            renderReport('report', data);
        }

        async function exportPDF() {
            const data = generateReportData();
            if (!data) return;
            const { schoolName, schoolAddress, contactNumber, font, textColor, photoBackgroundColor, backgroundOpacity,
                    studentName, admissionNumber, studentSex, classType, term, position,
                    schoolOpens, schoolCloses, reopenDate, schoolOpenCount, studentPresentCount, averageAttendance,
                    teacherRemark, photo, logo, watermark, backgroundColor, photoPosition,
                    subjects, cumulativeTotal, cumulativeAverage, overallGrade, studentTitle } = data;

            const doc = new jsPDF({ format: 'a4' });
            // Background color with opacity
            if (backgroundColor && backgroundColor !== '#ffffff') {
                doc.setFillColor(...hexToRgb(backgroundColor), backgroundOpacity);
                doc.rect(0, 0, 210, 297, 'F');
            }
            // Watermark
            if (watermark) {
                const imgData = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(watermark);
                });
                doc.addImage(imgData, 'JPEG', 0, 0, 210, 297, '', 'NONE', 0.1);
            }
            // Set font and text color
            doc.setFont(font.toLowerCase());
            doc.setTextColor(...hexToRgb(textColor));
            // Header
            let y = 10;
            if (logo) {
                const imgData = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(logo);
                });
                doc.addImage(imgData, 'JPEG', 90, 10, 30, 30);
                y = 45;
            }
            doc.setFontSize(18);
            doc.text(schoolName || 'School Name', 105, y, { align: 'center' });
            y += 10;
            doc.setFontSize(11);
            doc.text(schoolAddress || 'N/A', 105, y, { align: 'center' });
            y += 4;
            doc.text(contactNumber || 'N/A', 105, y, { align: 'center' });
            y += 4;
            doc.setFontSize(12);
            doc.text('STUDENT REPORT CARD', 105, y, { align: 'center' });
            doc.line(80, y + 1, 130, y + 1); // Underline
            y += 6;
            // Student details
            doc.setFontSize(10);
            doc.setFillColor(224, 231, 255); // Gradient start color
            doc.rect(10, y, 190, 35, 'F'); // Background for student details
            if (photo) {
                doc.setFillColor(...hexToRgb(photoBackgroundColor));
                doc.rect(photoPosition === 'left' ? 20 : 150, y + 5, 25, 25, 'F');
                const imgData = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(photo);
                });
                doc.addImage(imgData, 'JPEG', photoPosition === 'left' ? 20 : 150, y + 5, 25, 25, '', 'NONE', 0.9);
            }
            doc.text(`Student: ${studentName}`, photoPosition === 'left' ? 50 : 20, y + 5);
            doc.text(`Admission Number: ${admissionNumber}`, photoPosition === 'left' ? 50 : 20, y + 10);
            doc.text(`Sex: ${studentSex}`, photoPosition === 'left' ? 50 : 20, y + 15);
            doc.text(`Class: ${classType}`, photoPosition === 'left' ? 50 : 20, y + 20);
            doc.text(`Term: ${term}`, photoPosition === 'left' ? 50 : 20, y + 25);
            doc.text(`Position: ${position}`, photoPosition === 'left' ? 50 : 20, y + 30);
            y += 35;
            // School info
            doc.text(`School Opens: ${schoolOpens || 'N/A'}`, 20, y);
            y += 5;
            doc.text(`School Closes: ${schoolCloses || 'N/A'}`, 20, y);
            y += 5;
            doc.text(`Reopen Date: ${reopenDate || 'N/A'}`, 20, y);
            y += 5;
            doc.text(`No. of Times School Opens: ${schoolOpenCount || 'N/A'}`, 20, y);
            y += 5;
            doc.text(`No. of Times Student Present: ${studentPresentCount || 'N/A'}`, 20, y);
            y += 5;
            doc.text(`Average Attendance: ${averageAttendance || 'N/A'}%`, 20, y);
            y += 6;
            // Table
            const gradeColors = {
                'A': [40, 167, 69],  // #28a745
                'B': [0, 123, 255],  // #007bff
                'C': [253, 126, 20], // #fd7e14
                'D': [111, 66, 193], // #6f42c1
                'F': [220, 53, 69]   // #dc3545
            };
            const gradeColumnIndex = classType.startsWith('Basic') ? (term === 'Third' ? 11 : 7) : (term === 'Third' ? 10 : 6);
            let tableData = subjects.map(subject => [
                subject.subjectName,
                subject.subjectPosition,
                subject.ca1.toString(),
                subject.ca2.toString(),
                subject.ca3.toString(),
                ...(classType.startsWith('Basic') ? [subject.ca4.toString()] : []),
                subject.exam.toString(),
                subject.termTotal.toString(),
                ...(term === 'Third' ? [
                    subject.firstTermTotal.toString(),
                    subject.secondTermTotal.toString(),
                    subject.overallTotal.toString(),
                    subject.average.toFixed(2)
                ] : []),
                subject.grade
            ]);
            if (term === 'Third') {
                tableData.push(['Cumulative', '', '', '', '', ...(classType.startsWith('Basic') ? [''] : []), '', '', '', cumulativeTotal.toString(), cumulativeAverage.toFixed(2), '']);
            }
            doc.autoTable({
                startY: y,
                head: [[
                    'Subject', 'Position', 'CA1', 'CA2', 'CA3',
                    ...(classType.startsWith('Basic') ? ['CA4'] : []),
                    'Exam', `${term} Term`,
                    ...(term === 'Third' ? ['First Term', 'Second Term', 'Total', 'Average'] : []),
                    'Grade'
                ]],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [44, 62, 80], fontSize: 8, textColor: [255, 255, 255] },
                styles: { fontSize: 8, cellPadding: 1.5, overflow: 'linebreak', font: font.toLowerCase(), textColor: hexToRgb(textColor) },
                columnStyles: { 
                    0: { cellWidth: 25 },
                    [gradeColumnIndex]: { 
                        cellFilter: function (value) {
                            return value;
                        },
                        textColor: function (rowData) {
                            return gradeColors[rowData[gradeColumnIndex]] || hexToRgb(textColor);
                        }
                    }
                },
                margin: { top: 10, bottom: 40, left: 10, right: 10 }
            });
            // Summary and remarks
            y = doc.lastAutoTable.finalY + 6;
            doc.setFontSize(10);
            doc.setTextColor(...hexToRgb(textColor));
            doc.text(`Cumulative Total: ${cumulativeTotal.toFixed(2)}`, 20, y);
            y += 5;
            doc.text(`Cumulative Average: ${cumulativeAverage.toFixed(2)}`, 20, y);
            y += 5;
            doc.setTextColor(...(gradeColors[overallGrade] || hexToRgb(textColor)));
            doc.text(`Overall Grade: ${overallGrade}`, 20, y);
            y += 5;
            doc.setTextColor(...hexToRgb(textColor));
            doc.text(`Teacher's Remark: ${teacherRemark || 'N/A'}`, 20, y);
            y += 5;
            doc.text(`Head Teacher's Remark: ——————`, 20, y);
            y += 5;
            doc.setFontSize(12);
            doc.setFont(font.toLowerCase(), 'italic');
            doc.text(`Student Title: ${studentTitle}`, 105, y, { align: 'center' });
            doc.save('report_card.pdf');

            renderReport('report', data);
        }

        document.getElementById('classSelect').addEventListener('change', () => {
            document.getElementById('subjectInputs').innerHTML = '';
            addSubject();
        });
        document.getElementById('termSelect').addEventListener('change', () => {
            document.getElementById('subjectInputs').innerHTML = '';
            addSubject();
        });
        addSubject(); // Add one subject input by default
    </script>
</body>
</html>